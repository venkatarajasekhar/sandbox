
Q: what is RESTful web service?
Use verbs (HTTP protocol or GET, POST, PUT, DELETE, COPY, HEAD... ) + URL to identify resource to do operation
A RESTful web service (also called a RESTful web API) is a web service implemented using HTTP and the principles of REST. It is a collection of resources, with four defined aspects:
the base URI for the web service, such as http://example.com/resources/
the Internet media type of the data supported by the web service. This is often XML but can be any other valid Internet media type providing that it is a valid hypertext standard.
the set of operations supported by the web service using HTTP methods (e.g., GET, PUT, POST, or DELETE).
The API must be hypertext driven.[11][12]

GET: request the specified database, document, design doc, or other object or functionality.
HEAD : get header only
POST: Upload or send data
PUT: Used to put a specified resource with a specified ID or other identifier
DELETE: Deletes the specified resource, including documents, views, and design documents.
COPY: A specified method that can be used to copy documents and objects.

Q: what is CRUD?
Create, Read, Update, Delete which are database operations.
Those operations are mapped with the HTTP protocol.

Q: What is JSON?
A simplified version of XML!
No XPATH, etc

Q: What is FUTON?
FUTON is the adminstrator interface to couchdb
http://127.0.0.1:5984/_utils/database.html?contacts/_temp_view

Q: What is the GET method used for?
to read information

Q: What is the COPY method used for?
To copy entries

Q: What is the POST method used for?
To send information.
The information is in the body of the send
Used for views, and record creation

Q: what is the PUT method used for?
To send information, but
the information is passed in the URL

Q: Difference between PUT and POST?
curl -X PUT     http://127.0.0.1:5984/contacts
PUT is like creating a file for the FIRST time. If the file exist, then it fails
POST is for overwritting that file once created. If the file doesn't exist --> fail

ADMIN
-----

Q: How do you create a administrator?
Create an entry in the /etc/couchdb/local.ini file, and restart the couchdb demon.
This last operation hash the clear password in the configuration file.
The password could also have been hashed before entry.

DATABASE
--------

Q: What is the format of database names?
Only lowercase characters (a-z), digits (0-9), and any of the characters _, $, (, ), +, -, and / are allowed. 
Must begin with a letter.
curl -X PUT     http://127.0.0.1:5984/contacts
curl -X DELETE  http://127.0.0.1:5984/contacts


DOCUMENTS
---------

Q: what is a document?
A document is the equivalent of a row in a RDBMS database.
A document is a formatted with JSON
Two columns can have the same key (_id), but they have different revision number
One overwrites the other

Q: What is the key/id/_id?
It is the part of the last part of the URL that was used to create the document
{"id":"a1","key":"a1","value":{"rev":"1-9cd964ec2a49417216f3a913692aa7fa"},"doc":{"_id":"a1","_rev":"1-9cd964ec2a49417216f3a913692aa7fa","name":"Jack Sawyer","salary":30000,"department":"Sales"}},
was created with
curl -X PUT http://127.0.0.1:5984/employees/a1 -d '{"name": "Jack Sawyer", "salary":30000,"department":"Sales"}'

Q: What is the minimum numbers of fields in a document?
Two = the id and the revision number.
curl -X POST http://127.0.0.1:5984/bsic -d '{}'

Q: what is the maximum length of an entry in a document?
An entry can be as long as you want.
For the word count example, the document field content is the content of a speech!

Q: What is the format of the document entries?
Text only? Or so it seems!

Q: What is the purpose of the _id field?
In a REST application, this is the part of the URL to get the entry

Q: What are revisions?
Entries are not deleted/overwritten, but appended like in a log file.
Beware only the last revision is kept when compacting the db.

Q: What does compacting the db means?
Reducing the db in size by compressing it?, by removing old revisions of newer entries.

Q: What do we submit the rev in the DELETE operation URL?
A: Because the beginning URL 
http://localhost:5984/recipes/lasagne 
refers to several documents + fail safe
curl -H 'Content-type: application/json'
    -X DELETE http://localhost:5984/recipes/lassagne?rev=2-234j234234u23iu43423
{"ok":true, "id":"lasagne","rev":"3-efsd fsdfsdfsdf"}

SHOW & LIST
-----------

Q: How to create applications?
In couchdb, application are document.
For instance, the blog application, SOfa, is stored in a design document with the ID _design/sofa

The static HTML pages of our application are served as attachments to the design document.
Views and validation however are directly included in the design document's JSON body.

Q: What are show and list functions?
Show & list functions transform any document into any format
Those are a little like action in the traditional web frameworks-- they run some code based on a request and render response.

VIEWS
-----

Q: What is a view?
Map and reduce
With FUTON, select the Database and create a temporary view
A view in couchDb is also a document

Q: How to create a permanent view?
Once a temporary view has been create in FUTTON, use the [Save As] button
Permanent views are saved in (_design/contacts)

Q: How to access permanent views?
In the view combo, select the "Design documents"
Views are also stored in JSON documents!
{
   "_id": "_design/custom_views",
   "_rev": "2-b5ecaec3894e5056bcbf90d3e48db051",
   "language": "javascript",
   "views": {
       "view1": {
           "map": "function(doc) {\n  emit(doc._id, doc);\n}"
       },
       "view2": {
           "map": "function(doc) {\n  emit(doc._id, doc);\n}"
       }
   }
}

Q: How to query the view?
curl http://127.0.0.1:5984/basic/_design/custom_views/view1
??? curl http://127.0.0.1:5984/basic/_design/designdocname/_view/view1 ???

Q: What happens when a view is queried?
If it is the first time, the B-tree is built and all documents are parsed.
If it is the second time, the B-tree is updated with the documents that have changed since last run.


VIEWS AND MAP REDUCE
--------------------

Q: What are views used for?
* Filter the documents in your database to find those relevant to a particular process
* Extract data from documents and presenting it in a specific order
* Build efficient indexes to find documents by any value or structure that resides in them
* Use these indexes to represent relatinoships among documents
* Make calculations on the data in the documents

Q: What does the map function do?
map function produces a row for each document is processes

function(doc) {
    emit(doc.name, 1)                                           <-- emit(key, value)
}

doc is the document in JSON format
doc.name is the value of the name entry in the JSON doc
!!! emitted key can be arrays 
!!! emitted values can be JSON
ex:
    emit([doc.employee_no, 0], doc)

Q: what does the reduce function do?
The reduce function produces a single result for all the documents.
Reduce functions are used to aggregate data
ex:
function(keys, values, rereduce) {              
    return sum(values);
}

Q: What is the purpose of the rereduce flag?
If rereduce is false:
Once the input has entirely been processed by the map function, the reduce function is run for every single key
keys = list of keys and IDS for each row emitted by the map function?
values =  an array of the values emitted by the map function (for the specific key?)
rereduce = false

If rereduce is true:
The input data is to big. It is split into smaller batches. Several reduce function will run in parallel.
A cascaded reduce function will take the results from all the previous reduce fct and will summarise the data.
* the keys argument will be null
* the values argument will be an array of the RETURNED results produced by the previous invocation of the reduce function.

!!! The type of data in the values argument is always the same, regardless of whether rereduce is true or false

!!! rereduce is set to false with ...?group=true
!!! FUTON set rereduce to false by default

Q: What are the result of a view?
CouchDb takes what you pass into the emit() function and puts it into a list.
Each row in that list include the key and value
More importantly the list is SORTED by key

Q: How does the view work?
The view is run on every document... the first time.
If a document is changed, the map function is only run once, to recompute the keys and values for that single document.


SQL TO MAPREDUCE
-----------------

Q: How to create the equivalent of a table in NOSQL?
If table SQL = contacts, then create a schema field for each document set as contact
To query this table then use a map function that starts with:
function(doc) {
    if(doc.schema!= "contact") return;
    emit([doc.country, doc.name], {name:doc.name, email: doc.email});
}

Q: Transform SQL SELECT statement in map reduce?
SELECT id, name, email FROM contacts WHERE country = 'USA' ORDER BY name
method: POST    <-- always for views!
map function:
function(doc) {
    if(doc.schema!= "contact") return;
    emit([doc.country, doc.name], {name:doc.name, email: doc.email});
}
reduce:
-
view's URI:
...?startkey=["USA",{}]&endkey=["USA",{}]

SELECT COUNT(*), country FROM contacts GROUP BY country
method: POST
map:
function(doc) {
    emit(doc.country, 1);
}
reduce:
function(key, values, rereduce) {
    return sum(values);
}
view's URI:
...?group=true

Q: How to have several tables?
Use a field called schema or type that will be the name of the table.
Then in map reduce you can filter on this field.

Q: How to do a join between 2 tables?
Use a view collaboration !
Assuming that you have several document schema-types (~sql table)

map:
function(doc) {
    if(doc.type == "employee")
        emit([doc.employee_no, 0], doc);
    if (doc.type == "payslip")
        emit([doc.employee_no,1],doc);
}


JSON
----

Q: Which types does JSON support?
JSON supports the same basic types as supported by Javascript

Number
String:     { "from": "Joe Blog" }
Boolean:    { "value": true}
Array:      { "tags": ["one", "two", "three"] }
Object:     { "servings" : 4, "cooktime":60, "title": "Chicken Coriander" }


ATTACHEMENTS
------------


Q: How to send an attachment?
This can be done 2 ways: inline or offline.
Inline means at the creation of the document
Offline means after the document has been created.
Beware that the offline method copies the original document and create a new one (as if inline'd!)

Q: How to get an attachment?
HTTP protocol 
GET /database/attachment_doc is document
GET /database/attachment_doc/attachment.jpg is attached image file

UPDATE AND FILTER
-----------------

Q: What are _update JSON entries?
With and _update handler, you can POST XML directly in couchdb and it will parse the XML into JSON document and save it.
The same goes for CSV, multi-part form, or any other format.
