RESTful 
-------

Q: what is CRUD?
Create, Read, Update, Delete which are database operations.
Those operations are mapped with the HTTP protocol.

Q: what is RESTful web service?
Use verbs (HTTP protocol or GET, POST, PUT, DELETE, COPY, HEAD... ) + URL to identify resource to do operation
A RESTful web service (also called a RESTful web API) is a web service implemented using HTTP and the principles of REST. It is a collection of resources, with four defined aspects:
the base URI for the web service, such as http://example.com/resources/
the Internet media type of the data supported by the web service. This is often XML but can be any other valid Internet media type providing that it is a valid hypertext standard.
the set of operations supported by the web service using HTTP methods (e.g., GET, PUT, POST, or DELETE).
The API must be hypertext driven.[11][12]

GET: request the specified database, document, design doc, or other object or functionality.
GET: used to read information
HEAD : get header only
POST: Upload or send data
POST: To send infomration. The info is in the body of the send (<>PUT). Used for views and record creation.
PUT: Used to put a specified resource with a specified ID or other identifier
PUT: Used to send information, but the information is passed in the URL
DELETE: Deletes the specified resource, including documents, views, and design documents.
COPY: A specified method that can be used to copy documents and objects.

Q: Difference between PUT and POST?
curl -X PUT     http://127.0.0.1:5984/contacts
PUT is like creating a file for the FIRST time. If the file exist, then it fails
POST is for overwritting that file once created. If the file doesn't exist --> fail

JSON
----

Q: What is JSON?
A simplified version of XML!
No XPATH, etc

Q: Which types does JSON support?
JSON supports the same basic types as supported by Javascript

Nulls:      { "Toto": null }
Number:     { "Density": 5.6e+24 }
String:     { "from": "Joe Blog" }
Boolean:    { "value": true}
Array:      { "tags": ["one", "two", "three"] }
List:       { "servings" : 4, "cooktime":60, "title": "Chicken Coriander" }
Object:     aka List!

There is a subtle but important difference between floating-point numbers and decimals. 
When you use a number like 15.7, this will be interpreted as 15.699999999999999 by most clients, 
which may be problematic for your application. i
For this reason, currency values are usually better represented as strings in JSON. 
A string like "15.7" will be interpreted as "15.7" by every JSON client.

B-TREE
-------

Q: What is the internal storage methode of CouchDb
The nodes of a B-tree have a fixed capacity to contain up to 2k (k is a natural number) index elements 
and 2k+1 pointers to child nodes.
A B-tree of order k=2 (min:  2 elements/node, max: 4 elements/node, 5 pointers/node )
             [    7          16     .  . ]
               /      |           \
     [ 1 2 4 5 ]    [ 9 12 . . ]   [ 18 21 . . ]

A B-tree is kept balanced by requiring that all leaf nodes be at the same depth
A typical B-tree has a single-digit height, even with millions of entries

If 4 elements: only 1 level
If 5 elements: 1 + 2*2 (split)
If insert 10 above ==> [9 10 12 . ]      <-- leaf insert
If insert 6 ==> [1 2 4 5 6] is split in [1 2] and [5 6], 4 is pushed up, or [ 4 7 16 . ]
Insertion always in leaf and split may be required. A split push up the 'middle' value.
The node above may need to be split again. If that's the case, the middle value is always pushed upward.
A root split is the only event which increases the height of a B-tree, and obviously is extremely rare.

Deletion of the just inserted key would result in the original tree.
Deletion of an index element may cause a node P to contain only k-1 elements. 
If a sibling node Q (left or right) of P contains only k elements, P and Q are merged. 
Otherwise P and Q are merged only briefly (now containing more than 2k elements) in main memory 
and are immediately split again in the middle

Q: Advantage of B-trees over other storage methodes?
Accessing any part of the tree for reading or writing requires visiting only a few nodes, 
which translates to a few head seeks (which are what make a hard drive slow), 
and because the operating system is likely to cache the upper tree nodes anyway, 
only the seek to the final leaf node is needed.

ADMIN
-----

Q: What is FUTON?
FUTON is the adminstrator interface to couchdb
http://127.0.0.1:5984/_utils/database.html?contacts/_temp_view

Q: How do you create a administrator?
Create an entry in the /etc/couchdb/local.ini file, and restart the couchdb demon.
This last operation hash the clear password in the configuration file.
The password could also have been hashed before entry.

DATABASE
--------

Q: What is the format of database names?
Only lowercase characters (a-z), digits (0-9), and any of the characters _, $, (, ), +, -, and / are allowed. 
Must begin with a letter.
curl -X PUT     http://127.0.0.1:5984/contacts
curl -X DELETE  http://127.0.0.1:5984/contacts


DOCUMENTS
---------

Q: What is a document?
A document is the equivalent of a row in a RDBMS database.
A document is a formatted with JSON
Two columns can have the same key (_id), but they have different revision number
One overwrites the other

Q: WHat is the smallest document I can create?
curl -X PUT http://127.0.0.1:5984/employees/johntaylor -d '{}'
2 fields are created _id and _rev

Q: What is the purpose of the _id field?
In a REST application, this is the part of the URL to get the entry
_id: If I store something in CouchDB, it creates the _id and returns it to me
_id: I can use the _id to build the URL where I can get my something back.

Q: What are _rev revisions?
_rev describes a version of a document
Each change creates a new document version (that again is self-contained) and updates the _rev
Entries are not deleted/overwritten, but appended like in a log file.
Beware only the last revision is kept when compacting the db.

Q: What is the key/id/_id?
It is the part of the last part of the URL that was used to create the document
{"id":"a1","key":"a1","value":{"rev":"1-9cd964ec2a49417216f3a913692aa7fa"},"doc":{"_id":"a1","_rev":"1-9cd964ec2a49417216f3a913692aa7fa","name":"Jack Sawyer","salary":30000,"department":"Sales"}},
was created with
curl -X PUT http://127.0.0.1:5984/employees/a1 -d '{"name": "Jack Sawyer", "salary":30000,"department":"Sales"}'

Q: What is the minimum numbers of fields in a document?
Two = the id and the revision number.
curl -X POST http://127.0.0.1:5984/bsic -d '{}'

Q: what is the maximum length of an entry in a document?
An entry can be as long as you want.
For the word count example, the document field content is the content of a speech!

Q: What is the format of the document entries?
Text only? Or so it seems!

Q: What does compacting the db means?
Reducing the db in size by compressing it?, by removing old revisions of newer entries.

Q: What do we submit the rev in the DELETE operation URL?
A: Because the beginning URL 
http://localhost:5984/recipes/lasagne 
refers to several documents + fail safe
curl -H 'Content-type: application/json'
    -X DELETE http://localhost:5984/recipes/lassagne?rev=2-234j234234u23iu43423
{"ok":true, "id":"lasagne","rev":"3-efsd fsdfsdfsdf"}A

Q: Why when updating I need to provide a _rev ?
Because couchdb will then know what version you have been working against.
If the update that is submitted is not on the lastest rev, then your change is not accepted!
This is in case of concurrent updates from several clients.

DESIGN DOCUMENTS: SHOW & LIST
-----------------------------

Q: How to create applications?
In couchdb, application are document.
For instance, the blog application, SOfa, is stored in a design document with the ID _design/sofa

The static HTML pages of our application are served as attachments to the design document.
Views and validation however are directly included in the design document's JSON body.

Q: What are show and list functions?
Show & list functions transform any document into any format
Those are a little like action in the traditional web frameworks-- they run some code based on a request and render response.
Show: render in html/xml/csv/etc only 1 document
List: render in html/xml/csv/etc several documents

Q: What is a show function?
HTTP request + document ---(show function)--> HTTP response !

Q: How to call a show function?
GET /mydb/_design/mydesign/_show/myshow/72d43a93eb74b5f2
Note that the document ID (DocID) 72... must exist, otherwise HTTP 500 Internal Server Error response.
If no doc exist with this ID, the doc in the show function is null!
==> use wrapper: if (doc !== null) { ... } 

Q: Give me an example of show function
function(doc, req) {
    return "<p>toto" + req.urlparam + "!</p>";      <-- can use template here
}                                                   <-- return a response object (default text/html)
req is the request URL
req.urlparam is a parameter from the request URL (and not a document!)
GET /mydb/_design/mydesign/_show/myshow?urlparam=toto
doc is the document on which the show function is executed.
The DocID should also be in the URL.

Q: What does caching (squid) have to do with show/list?
Show replies can be searched and cached.
Use the req.urlparam technique sparingly as a document needs to be cached for each param.
The cache server and couchdb use ETAG to inform each other on whether the cache is up to date 
or whether the document has changed.

DESIGN DOCUMENTS: VIEWS
-----------------------

Q: What is a view?
Map and reduce
With FUTON, select the Database and create a temporary view
A view in couchDb is also a document

Q: How to create a permanent view?
Once a temporary view has been create in FUTTON, use the [Save As] button
Permanent views are saved in (_design/contacts)

Q: How to access permanent views?
In the view combo, select the "Design documents"
Views are also stored in JSON documents!
{
   "_id": "_design/custom_views",
   "_rev": "2-b5ecaec3894e5056bcbf90d3e48db051",
   "language": "javascript",
   "views": {
       "view1": {
           "map": "function(doc) {\n  emit(doc._id, doc);\n}"
       },
       "view2": {
           "map": "function(doc) {\n  emit(doc._id, doc);\n}"
       }
   }
}

Q: How to query the view?
curl http://127.0.0.1:5984/basic/_design/custom_views/view1
??? curl http://127.0.0.1:5984/basic/_design/designdocname/_view/view1 ???

Q: What happens when a view is queried?
If it is the first time, the B-tree is built and all documents are parsed.
If it is the second time, the B-tree is updated with the documents that have changed since last run.


DESIGN DOCUMENTS: VIEWS AND MAP REDUCE
--------------------------------------

Q: What are views used for?
* Filter the documents in your database to find those relevant to a particular process
* Extract data from documents and presenting it in a specific order
* Build efficient indexes to find documents by any value or structure that resides in them
* Use these indexes to represent relatinoships among documents
* Make calculations on the data in the documents

Q: What does the map function do?
map function produces a row for each document is processes

function(doc) {
    emit(doc.name, 1)                                           <-- emit(key, value)
}

doc is the document in JSON format
doc.name is the value of the name entry in the JSON doc
!!! emitted key can be arrays 
!!! emitted values can be JSON
ex:
    emit([doc.employee_no, 0], doc)

Q: what does the reduce function do?
The reduce function produces a single result for all the documents.
Reduce functions are used to aggregate data
ex:
function(keys, values, rereduce) {              
    return sum(values);
}

Q: What is the purpose of the rereduce flag?
If rereduce is false:
Once the input has entirely been processed by the map function, the reduce function is run for every single key
keys = list of keys and IDS for each row emitted by the map function?
values =  an array of the values emitted by the map function (for the specific key?)
rereduce = false

If rereduce is true:
The input data is to big. It is split into smaller batches. Several reduce function will run in parallel.
A cascaded reduce function will take the results from all the previous reduce fct and will summarise the data.
* the keys argument will be null
* the values argument will be an array of the RETURNED results produced by the previous invocation of the reduce function.

!!! The type of data in the values argument is always the same, regardless of whether rereduce is true or false

!!! rereduce is set to false with ...?group=true
!!! FUTON set rereduce to false by default

Q: What are the result of a view?
CouchDb takes what you pass into the emit() function and puts it into a list.
Each row in that list include the key and value
More importantly the list is SORTED by key

Q: How does the view work?
The view is run on every document... the first time.
If a document is changed, the map function is only run once, to recompute the keys and values for that single document.


DESIGN DOCUMENTS: SQL TO VIEW/MAPREDUCE
---------------------------------------

Q: How to create the equivalent of a table in NOSQL?
If table SQL = contacts, then create a schema field for each document set as contact
To query this table then use a map function that starts with:
function(doc) {
    if(doc.schema!= "contact") return;
    emit([doc.country, doc.name], {name:doc.name, email: doc.email});
}

Q: Transform SQL SELECT statement in map reduce?
SELECT id, name, email FROM contacts WHERE country = 'USA' ORDER BY name
method: POST    <-- always for views!
map function:
function(doc) {
    if(doc.schema!= "contact") return;
    emit([doc.country, doc.name], {name:doc.name, email: doc.email});
}
reduce:
-
view's URI:
...?startkey=["USA",{}]&endkey=["USA",{}]

SELECT COUNT(*), country FROM contacts GROUP BY country
method: POST
map:
function(doc) {
    emit(doc.country, 1);
}
reduce:
function(key, values, rereduce) {
    return sum(values);
}
view's URI:
...?group=true

Q: How to have several tables?
Use a field called schema or type that will be the name of the table.
Then in map reduce you can filter on this field.

Q: How to do a join between 2 tables?
Use a view collaboration !
Assuming that you have several document schema-types (~sql table)

map:
function(doc) {
    if(doc.type == "employee")
        emit([doc.employee_no, 0], doc);
    if (doc.type == "payslip")
        emit([doc.employee_no,1],doc);
}

TEMPLATES, FUNCTIONS, AND MACROS
---------------------------------

Q: What are the possible macros?
Macro are javascript comments followed by a ! (bang) and macro name.
Currently only 2 macros?
// !json template.edit              
    * followed by path to a file in the couchapp directory (dot notation)
    * equivalent to: var template.edit = "content of edit.*"
    * matches files with any extension !!!
// !json template
    * var template.edit = "content of edit*"
    * var template.post = "content of post*"

// !code vendor/couchapp/path.js
    * followed by js file
    * equivalent to an C-include

Q: What are templates?
Templates are used un show and list functions.
In show function,
return template(templates.edit, {
    doc: doc,
    docid : toJSON((doc && doc._id) || null),
    blog: blog,
    assets: assetPath(),
    ...
    });




ATTACHEMENTS
------------

Q: What is base64?
All attachments, including binary ones, are transformed into string with the base64 algorithm.
Base64 encoding schemes are commonly used when there is a need to encode binary data that need to be 
stored and transferred over media that are designed to deal with textual data. 
This is to ensure that the data remain intact without modification during transport. 
Base64 is commonly used in a number of applications including email via MIME, and storing complex data in XML.

Q: How to send an attachment?
This can be done 2 ways: inline or offline.
Inline means at the creation of the document
Offline means after the document has been created.
Beware that the offline method copies the original document and create a new one (as if inline'd!)

Q: How to get an attachment?
HTTP protocol 
GET /database/attachment_doc is document
GET /database/attachment_doc/attachment.jpg is attached image file

Q: How can I see attachement with FUTON?
Open the document. Look at the _attachments key.
Select the attachment you want to open.
The web browser should be able to open it itself.

UPDATE AND FILTER
-----------------

Q: What are _update JSON entries?
With and _update handler, you can POST XML directly in couchdb and it will parse the XML into JSON document and save it.
The same goes for CSV, multi-part form, or any other format.
