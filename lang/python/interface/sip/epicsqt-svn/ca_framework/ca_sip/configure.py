import os
import sipconfig
import shutil
from PyQt4 import pyqtconfig

#----------------------------------------------------------------------
# path(s) to check 
#----------------------------------------------------------------------

#Where pyqt sip are installed
pyqt4_sip = "/usr/share/sip/PyQt4"
top_sip = "/usr/share/sip"
epics_base_top = "/usr/local/epics/base/official"

#output location
home_top = "/home/cls1fs/epics/epics2/"
epicsqt_top = home_top + "/workspace/epicsqt/epicsqt-svn/"
ca_framework_top = epicsqt_top + "/ca_framework/"
sip_top = ca_framework_top + "/ca_sip/"

sipcode_dir = "./"
sipcode_dir =  sip_top + "/sipcode/"
try:
  os.mkdir(sipcode_dir)
except OSError:
  pass

# The name of the SIP build file generated by SIP and used by the build
# system.
build_file = sipcode_dir + "CaFramework.sbf"


# Get the SIP configuration information.
#config = sipconfig.Configuration()
# Get the PyQt configuration information. 
# On my machine /usr/lib64/python2.6/site-packages/PyQt4/pyqtconfig.py includes sip configuration
config = pyqtconfig.Configuration()

#----------------------------------------------------------------------
# CPP FILES
#----------------------------------------------------------------------

# Run SIP to generate the code.
sip_commandline = " ".join([config.sip_bin, "-c", sipcode_dir, "-b", build_file, "-I", config.pyqt_sip_dir, config.pyqt_sip_flags,  "CaFramework.sip"])
print sip_commandline + "\n"
os.system(sip_commandline)

#----------------------------------------------------------------------
# Makefile
#----------------------------------------------------------------------

# We are going to install the SIP specification file for this module and
# its configuration module.
installs = []
installs.append([ sip_top + "CaFramework.sip", os.path.join(config.default_sip_dir, "CaFramework")])
installs.append(["CaFramework_config.py", config.default_mod_dir])

# Create the Makefile.
#makefile = sipconfig.SIPModuleMakefile(config, build_file)
# Create the Makefile.  The QtGuiModuleMakefile class provided by the
# pyqtconfig module takes care of all the extra preprocessor, compiler and
# linker flags needed by the Qt library.
makefile = pyqtconfig.QtGuiModuleMakefile(
    configuration=config,
    build_file=build_file,
    installs=installs,
    makefile=sipcode_dir + "Makefile"
)

# Add the library we are wrapping.  The name doesn't include any platform
# specific prefixes or extensions (e.g. the "lib" prefix on UNIX, or the
# ".dll" extension on Windows).
makefile.extra_libs += ["QCaPlugin"]

makefile.extra_lib_dirs += [ ca_framework_top + "/plugins/"]

makefile.extra_include_dirs += [ epics_base_top + "/include"] # for cadef.h
makefile.extra_include_dirs += [ epics_base_top + "/src/libCom/osi/os/posix"]  # for osdEvent.h
makefile.extra_include_dirs += [ ca_framework_top + "/widgets/include"]
makefile.extra_include_dirs += [ ca_framework_top + "/data/include"]
makefile.extra_include_dirs += [ ca_framework_top + "/api/include"]
makefile.extra_include_dirs += [ ca_framework_top + "/plugins/include"]
makefile.extra_include_dirs += [ "/usr/include/QtCore"]
makefile.extra_include_dirs += [ "/usr/include/QtGui"]

# Generate the Makefile itself.
makefile.generate()

#----------------------------------------------------------------------
# Module config
#----------------------------------------------------------------------




# Now we create the configuration module.  This is done by merging a Python
# dictionary (whose values are normally determined dynamically) with a
# (static) template.
content = {
    # Publish where the SIP specifications for this module will be
    # installed.
    "CaFramework_sip_dir":    config.default_sip_dir,

    # Publish the set of SIP flags needed by this module.  As these are the
    # same flags needed by the qt module we could leave it out, but this
    # allows us to change the flags at a later date without breaking
    # scripts that import the configuration module.
    "CaFramework_sip_flags":  config.pyqt_sip_flags
}

# This creates the ca_frameworkconfig.py module from the CaFramework_config.py.in
# template and the dictionary.
sipconfig.create_config_module(sipcode_dir + "/CaFramework_config.py", sip_top + "/CaFramework_config.py.in", content)

